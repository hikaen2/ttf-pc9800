#!/usr/bin/env ruby
#
# jis2uni
#
# usage:
#   gem install unicode-name
#   ./jis2uni < Uni2JIS > JIS2Uni
#
# Copyright (c) 2013 Suzuki Taro
# MIT License
#

require 'optparse'
require 'unicode/name'

def kuten_to_jis(ku, ten)
  ((ku + 0x20) << 8) + (ten + 0x20)
end

mode = '0'
OptionParser.new
  .on('-0') {|v| mode = '0' } # JIS C 6226-1978
  .on('-1') {|v| mode = '1' } # JIS X 0208-1983
  .on('-2') {|v| mode = '2' } # JIS X 0208-1990
  .on('-S') {|v| mode = 'S' } # JIS X 0212-1990
  .parse!(ARGV)

jis_unicode = ARGF.read.scan(/^([0-9A-Fa-f]+)\t.*?#{mode}-(\d\d)(\d\d)/).map {|unicode, ku, ten| [kuten_to_jis(ku.to_i, ten.to_i), unicode.hex] }.sort
raise if jis_unicode.size != jis_unicode.uniq{|e| e[0]}.size # assertion
raise if jis_unicode.size != jis_unicode.uniq{|e| e[1]}.size # assertion

puts "# generated by jis2uni"
puts "# JIS\tUnicode"
jis_unicode.each do |jis, unicode|
  puts "0x%04X\t0x%04X\t#%s" % [jis, unicode, Unicode::Name.of([unicode].pack('U'))]
end
