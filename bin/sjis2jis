#!/usr/bin/env ruby
#
# sjis2jis.rb
# Usage: sjis2jis.rb < CP932.TXT > CP932.JIS.TXT
#
# Copyright (c) 2013 Suzuki Taro
# MIT License
#

require 'sqlite3'
require 'unicode/name'

def sjis_to_jis(sjis)
  hi = (sjis >> 8) & 0xff
  lo = sjis & 0xff
  return lo if hi == 0

  hi -= (hi<=0x9f) ? 0x71 : 0xb1
  hi = hi * 2 + 1
  lo -= (lo > 0x7f) ? 1 : 0
  hi += (lo >= 0x9e) ? 1 : 0
  lo -= (lo >= 0x9e) ? 0x7d : 0x1f
  return hi << 8 | lo
end

def jis_to_sjis(jis)
  return jis if jis <= 0x00ff
  hi = (jis >> 8) & 0x00ff
  lo = jis & 0x00ff
  lo += (hi & 0x01) == 1 ? 0x1f : 0x7d
  lo += 1 if lo >= 0x7f
  hi = (hi - 0x21 >> 1) + 0x81
  hi += 0x40 if hi > 0x9f
  return (hi << 8) | lo
end

puts '# generated by sjis2jis'
ARGF.each do |line|
  next if line[0] == '#'
  print line.sub(/0x[0-9a-fA-F]+/) {|sjis| '0x%04X' % sjis_to_jis(sjis.hex) }
end
